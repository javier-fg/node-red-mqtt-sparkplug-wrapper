<!--
  Copyright JS Foundation and other contributors, http://js.foundation
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<style>
    #sparkplug-input-metric-container-row .red-ui-editableList-header {
        display: flex;
        background: var(--red-ui-tertiary-background);
        padding-right: 75px;
    }
</style>

<script type="text/html" data-template-name="mqtt-sparkplug-broker">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.name"></span></label>
        <input type="text" id="node-config-input-name" data-i18n="[placeholder]mqtt-sparkplug-wrapper.label.name">
    </div>
    <div class="form-row">
        <ul style="min-width: 600px; margin-bottom: 20px;" id="node-config-mqtt-broker-tabs"></ul>
    </div>
    <div id="node-config-mqtt-broker-tabs-content" style="min-height:150px;">
        <div id="mqtt-broker-tab-connection" style="display:none">
            <div class="form-row node-input-broker">
                <label for="node-config-input-broker"><i class="fa fa-globe"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.server"></span></label>
                <input type="text" id="node-config-input-broker" style="width: calc(100% - 300px);" data-i18n="[placeholder]mqtt-sparkplug-wrapper.label.example">
                <label for="node-config-input-port" style="margin-left:20px; width:43px; "> <span data-i18n="mqtt-sparkplug-wrapper.label.port"></span></label>
                <input type="text" id="node-config-input-port" data-i18n="[placeholder]mqtt-sparkplug-wrapper.label.port" style="width:55px">
            </div>
            <div class="form-row" style="height: 34px;">
                <input type="checkbox" id="node-config-input-usetls" style="height: 34px; margin: 0 5px 0 104px; display: inline-block; width: auto; vertical-align: top;">
                <label for="node-config-input-usetls" style="width: 100px; line-height: 34px;"><span data-i18n="mqtt-sparkplug-wrapper.label.use-tls"></span></label>
                <span id="node-config-row-tls" class="hide"><input style="width: 320px;" type="text" id="node-config-input-tls"></span>
            </div>

            <div class="form-row">
                <label for="node-config-input-protocolVersion"><i class="fa fa-cog"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.protocolVersion"></span></label>
                <select id="node-config-input-protocolVersion" style="width:70%;">
                    <!--<option value="3" data-i18n="mqtt-sparkplug-wrapper.label.protocolVersion3"></option> -->
                    <option value="4" data-i18n="mqtt-sparkplug-wrapper.label.protocolVersion4"></option>
                    <!-- <option value="5" data-i18n="mqtt-sparkplug-wrapper.label.protocolVersion5"></option> -->
                </select>
            </div>
            <div class="form-row">
                <label for="node-config-input-clientid"><i class="fa fa-tag"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.clientid"></span></label>
                <input type="text" id="node-config-input-clientid" data-i18n="[placeholder]mqtt-sparkplug-wrapper.placeholder.clientid">
            </div>
            <div class="form-row">
                <label for="node-config-input-keepalive"><i class="fa fa-heartbeat"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.keepalive"></span></label>
                <input type="number" min="0" id="node-config-input-keepalive" style="width: 100px">
            </div>
            <div class="form-row" style="margin-bottom:0">
                <label style="vertical-align:top;"><i class="fa fa-info"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.session"></span></label>
                <div style="display: inline-block; width:calc(100% - 110px)">
                    <div class="form-row">
                        <label for="node-config-input-cleansession" style="width: auto;">
                            <input type="checkbox" id="node-config-input-cleansession" style="position: relative;vertical-align: bottom; top: -2px; width: 15px;height: 15px;">
                            <span id="node-config-input-cleansession-label" data-i18n="mqtt-sparkplug-wrapper.label.cleansession"></span>
                        </label>
                    </div>
                </div>
            </div>
            <br>
        </div>
        <div id="mqtt-broker-tab-security" style="display:none">
            <div class="form-row">
                <label for="node-config-input-user"><i class="fa fa-user"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.username"></span></label>
                <input type="text" id="node-config-input-user">
            </div>
            <div class="form-row">
                <label for="node-config-input-password"><i class="fa fa-lock"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.password"></span></label>
                <input type="password" id="node-config-input-password">
            </div>
        </div>
         <div id="mqtt-broker-tab-sparkplug" style="display:none">

            <!-- Add UI for compress output -->
            <div class="form-row">
                <label for="node-config-input-compressAlgorithm"><i class="fa fa-compress"></i> Compress</label>
                <select id="node-config-input-compressAlgorithm">
                    <option value="">No</option>
                    <option value="DEFLATE">Deflate</option>
                    <option value="GZIP">Gzip</option>
                </select>
            </div>

            <!-- UI for Alias Metrics-->
            <div class="form-row">
            <label for="node-config-input-aliasMetrics" style="width:70%">
                <input type="checkbox" id="node-config-input-aliasMetrics" style="display:inline-block; width:22px; vertical-align:top;"><span data-i18n="mqtt-sparkplug-wrapper.label.aliasMetrics"></span>
            </label>
            </div>

            <!-- Add UI for Store forward -->
            <div class="form-row">
                <label for="node-config-input-enableStoreForward" style="width:70%">
                    <input type="checkbox" id="node-config-input-enableStoreForward" style="display:inline-block; width:22px; vertical-align:top;"><span data-i18n="mqtt-sparkplug-wrapper.label.storeforward"></span>
                </label>
                </div>
            <div class="form-row" id="node-storeforward-line">
                <label for="node-config-input-primaryScada"><i class="fa fa-desktop"></i> Destination</label>
                <input id="node-config-input-primaryScada" type="text" placeholder="Primary SCADA Name">
            </div>
        </div>
    </div>
</script>

<script type="text/javascript">
(function() {

    RED.nodes.registerType('mqtt-sparkplug-broker',{
        category: 'config',
        defaults: {
            name: {value:"" },
            broker: {value:"",required:true},
            port: {value:1883,required:false,validate:RED.validators.number(true)},
            tls: {type:"tls-config",required: false},
            clientid: {value:"", validate: function(v) {
                if ($("#node-config-input-clientid").length) {
                    // Currently editing the node
                    return $("#node-config-input-cleansession").is(":checked") || (v||"").length > 0;
                } else {
                    return (this.cleansession===undefined || this.cleansession) || (v||"").length > 0;
                }
            }},

            usetls: {value: false},
            verifyservercert: { value: false},
            protocolVersion: { value: 4},
            keepalive: {value:60,validate:RED.validators.number()},
            cleansession: {value: true},
            enableStoreForward: {value: false},
            compressAlgorithm : {value: false},
            aliasMetrics : {value: false},
            primaryScada: {value:"",  validate :x =>  !$("#node-config-input-enableStoreForward").is(":checked") || /^[^/+#]+$/.test(x) },
        },
        credentials: {
            user: {type:"text"},
            password: {type: "password"}
        },
        label: function() {
            if (this.name) {
                return this.name;
            }
            var b = this.broker;
            if (!b) { b = "undefined"; }
            var lab = "";
            lab = (this.clientid?this.clientid+"@":"")+b;
            if (b.indexOf("://") === -1){
                if (!this.port){ lab = lab + ":1883"; }
                else { lab = lab + ":" + this.port; }
            }
            return lab;
        },
        oneditprepare: function () {
            var tabs = RED.tabs.create({
                id: "node-config-mqtt-broker-tabs",
                onchange: function(tab) {
                    $("#node-config-mqtt-broker-tabs-content").children().hide();
                    $("#" + tab.id).show();
                }
            });
            tabs.addTab({
                id: "mqtt-broker-tab-connection",
                label: this._("mqtt-sparkplug-wrapper.tabs-label.connection")
            });
            tabs.addTab({
                id: "mqtt-broker-tab-security",
                label: this._("mqtt-sparkplug-wrapper.tabs-label.security")
            });

            tabs.addTab({
                id: "mqtt-broker-tab-sparkplug",
                label: this._("mqtt-sparkplug-wrapper.tabs-label.sparkplug")
            });

            setTimeout(function() { tabs.resize(); },0);
            if (typeof this.cleansession === 'undefined') {
                this.cleansession = true;
                $("#node-config-input-cleansession").prop("checked",true);
            }
            if (typeof this.usetls === 'undefined') {
                this.usetls = false;
                $("#node-config-input-usetls").prop("checked",false);
            }
            
            $("#node-config-input-protocolVersion").on("change", function() {
                $("#node-config-input-cleansession-label").text(RED._("node-red:mqtt.label.cleansession"))
            });
            $("#node-config-input-protocolVersion").val(this.protocolVersion);
        
            $("#node-storeforward-line").hide();
            $("#node-config-input-enableStoreForward").on('change',function() {
                if ($(this).is(":checked")) {
                    $("#node-storeforward-line").show();
                }
                else {
                    $("#node-storeforward-line").hide();
                }
            });

            function updateTLSOptions() {
                if ($("#node-config-input-usetls").is(':checked')) {
                    $("#node-config-row-tls").show();
                } else {
                    $("#node-config-row-tls").hide();
                }
            }
            updateTLSOptions();
            $("#node-config-input-usetls").on("click",function() {
                updateTLSOptions();
            });
            var node = this;
            function updateClientId() {
                if ($("#node-config-input-cleansession").is(":checked")) {
                    $("#node-config-input-clientid").attr("placeholder",node._("mqtt-sparkplug-wrapper.placeholder.clientid"));
                } else {
                    $("#node-config-input-clientid").attr("placeholder",node._("mqtt-sparkplug-wrapper.placeholder.clientid-nonclean"));
                }
                $("#node-config-input-clientid").trigger("change");
            }
            setTimeout(updateClientId,0);
            $("#node-config-input-cleansession").on("click",function() {
                updateClientId();
            });

            function updatePortEntry(){
                var disabled = $("#node-config-input-port").prop("disabled");
                if ($("#node-config-input-broker").val().indexOf("://") === -1){
                    if (disabled){
                        $("#node-config-input-port").prop("disabled", false);
                    }
                }
                else {
                    if (!disabled){
                        $("#node-config-input-port").prop("disabled", true);
                    }
                }
            }
            $("#node-config-input-broker").on("change", function() {
                updatePortEntry();
            });
            $("#node-config-input-broker").on( "keyup", function() {
                updatePortEntry();
            });
            setTimeout(updatePortEntry,50);
            setTimeout(function() {
                $("#node-config-input-protocolVersion").trigger("change");
            },50);

        },
        oneditsave: function() {
            if (!$("#node-config-input-usetls").is(':checked')) {
                $("#node-config-input-tls").val("");
            }
        }
    });
})();
</script>

<!-- Sparkplug device -->
<script type="text/html" data-template-name="sparkplug device">

    <div class="form-row">
        <label for="node-input-name"><span data-i18n="mqtt-sparkplug-wrapper.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]mqtt-sparkplug-wrapper.placeholder.name">
    </div>
    <div class="form-row">
        <label for="node-input-broker"><i class="fa fa-globe"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.broker"></span></label>
        <input type="text" id="node-input-broker">
    </div>

    <div class="form-row">
        <ul style="min-width: 600px; margin-bottom: 20px;" id="node-mqtt-device-tabs"></ul>
    </div>

    <div id="node-mqtt-device-tabs-content" style="min-height:150px;">
        <div id="mqtt-device-tab-metrics" style="display:none">
            <div class="form-row sparkplug-input-metric-row" id="sparkplug-input-metric-container-row">
                <ol id="sparkplug-input-metric-container"></ol>
            </div>
            <div class="form-tips"><span data-i18n="mqtt-sparkplug-wrapper.tip.device"></span></div>
        </div>

        <div id="mqtt-device-tab-advanced" style="display:none">

            <div class="form-row">
                <label for="node-input-broker"><span data-i18n="mqtt-sparkplug-wrapper.label.nodetype"></span></label>
                <span class="button-group">
                    <button type="button" data-value="eond" class="red-ui-button toggle device-type-button-group selected">Device (EoND)</button>
                    <button type="button" data-value="eon" class="red-ui-button toggle device-type-button-group">Node (EoN)</button>
                </span>
            </div>
            <div class="form-row">
                <label for="node-input-spEond"><i class="fa fa-tasks"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.eond"></span></label>
                <input type="text" id="node-input-spEond" data-i18n="[placeholder]mqtt-sparkplug-wrapper.placeholder.eondname">
            </div>
            <div class="form-row">
                <label for="node-input-spEon"><i class="fa fa-tasks"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.eon"></span></label>
                <input type="text" id="node-input-spEon" data-i18n="[placeholder]mqtt-sparkplug-wrapper.placeholder.eonname">
            </div>
            <div class="form-row">
                <label for="node-input-spGroup"><i class="fa fa-tasks"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.group"></span></label>
                <input type="text" id="node-input-spGroup" data-i18n="[placeholder]mqtt-sparkplug-wrapper.placeholder.groupname">
            </div>
             <!-- UI for birthImmediately-->
            <div class="form-row">
                <label for="node-input-birthImmediately" style="width:70%">
                    <input type="checkbox" id="node-input-birthImmediately" style="display:inline-block; width:22px; vertical-align:top;"><span data-i18n="mqtt-sparkplug-wrapper.label.birthImmediately"></span>
                </label>
            </div>
            <div class="form-tips"><span data-i18n="mqtt-sparkplug-wrapper.tip.birthImmediately"></span></div>
            
        </div>

    </div>
</script>

<script type="text/javascript">
(function() {

    /**
    * Function that returns a list of configured Metrics
    * @return   {Object} A object with all configured metrics.
    */
    function getMetricsList() {
        var _metrics = {};
        var metrics = $("#sparkplug-input-metric-container").editableList("items");
        metrics.each(function(i) {
            var item = $(this);
            var name = item.find(".sparkplug-input-metric-name").val();
            var dt = item.find(".sparkplug-input-metric-dateType option:selected").text();
           
            if (name) {
                _metrics[name] = { dataType : dt};
            }
        });
        return _metrics;
    }

    RED.nodes.registerType('sparkplug device',{
        category: 'network',
        defaults: {
            name: {value:""},
            spEond: {value:"",  validate :x => /^[^/+#]*$/.test(x)},
            spEon: {value:"",  validate :x => /^[^/+#]*$/.test(x)},
            spGroup: {value:"",  validate :x => /^[^/+#]*$/.test(x)},
            isEond: {value:true},
            metrics: {value:{}, required:true, /*validate : x => Object.keys(x).length > 0*/ }, // do regex matching of invalid charaters (e.g. # or +)
            broker: {type:"mqtt-sparkplug-broker", required:true},
            birthImmediately: {value: false},
        },
        color:"#2181a6",
        inputs:1,
        outputs:1,
        icon: "sparkplug.svg",
        inputLabels: "Input DDATA metrics",
        outputLabels: "Received DCMD metrics",
        align: "right",
        label: function() {
            return this.name||"Sparkplug Device";
        },
        oneditprepare: function() {
            var that = this;

            var tabs = RED.tabs.create({
                id: "node-mqtt-device-tabs",
                onchange: function(tab) {
                    $("#node-mqtt-device-tabs-content").children().hide();
                    $("#" + tab.id).show();
                }
            });

            tabs.addTab({
                id: "mqtt-device-tab-metrics",
                label: this._("mqtt-sparkplug-wrapper.tabs-label.metrics"),
                iconClass: "fa fa-cubes",
            });
            tabs.addTab({
                id: "mqtt-device-tab-advanced",
                label: this._("mqtt-sparkplug-wrapper.tabs-label.sparkplugNode"),
                iconClass: "fa fa-cog"
            });

            // Setup model 
            var metricsList = $("#sparkplug-input-metric-container").editableList( {
                header: $("<div>").append($.parseHTML("<div style='width:80%; display: inline-grid'>Name</div><div style='display: inline-grid'>Type</div>")),
                addButton: "add",
                removable: true,
                height: 300,
                addItem: function(container,i,opt) {
                    var parent = container.parent();
                    var row = $("<div/>").addClass("sparkplug-input-metric").appendTo(container);
                    var fmoduleSpan = $("<span>").appendTo(row);
                    var fmodule = $("<input/>", {
                        class: "sparkplug-input-metric-name",
                        placeholder: "Metric Name",
                        type: "text"
                    }).css({
                    }).appendTo(fmoduleSpan).val(opt.name);

                    var selectField = $('<select/>',{
                        style:"width:110px; margin-left: 5px; text-align: center;",
                        class : "sparkplug-input-metric-dateType"
                    }).appendTo(row);
                    var group0 = $('<optgroup/>', { label: "Datatypes" }).appendTo(selectField);
                    
                    var dt = ["Int8", "Int16", "Int32", "Int64", "Float", "Double", "Boolean" , "String", "Unknown"];
                    dt.forEach(d => {
                        let option = $("<option></option>").val(d).text(d);
                        group0.append(option);
                        if (d === opt.dataType || (Object.keys(opt).length === 0 && d === "Int32")) {
                            option.attr('selected','selected')
                        }
                    });
                }
            });
            var metrics = this.metrics || {};
       
            for (const [key, value] of Object.entries(metrics)) {
                value["name"] = key;
                metricsList.editableList('addItem', value)
            };

            // Selection of Eond / Eon
            function updateTextBoxEond() {
                if (that.isEond) {
                    $("#node-input-spEond").prop('disabled', false);
                } else {
                    $("#node-input-spEond").prop('disabled', true);
                }
            }
            function updateselectButtonNodeType() {

                updateTextBoxEond(); // Update text box state based on selected option

                var savedOption = (that.isEond) ? "eond" : "eon";
                $(".device-type-button-group").each(function() {
                    if ($(this).attr('data-value') === savedOption) {
                        $(this).addClass("active");
                    } else {
                        $(this).removeClass("active");
                    }
                });
            }
            $(".device-type-button-group").on("click", function() {
                $(".device-type-button-group").removeClass("selected");
                $(this).addClass("selected")
                that.isEond = $(this).attr("data-value") == "eond";
                updateTextBoxEond();
            });
            updateselectButtonNodeType();

        },
        oneditsave: function() {
            var node = this;
            node.metrics = getMetricsList();
            this.warn("Saving...");
            this.warn($(this).attr('data-value'));
        },

        labelStyle: function() {
            return this.name?"node_label_italic":"";
        }
    });
})();
</script>

<!-- sparkplug in -->
<script type="text/html" data-template-name="sparkplug in">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]mqtt-sparkplug-wrapper.label.name">
    </div>
    <div class="form-row">
        <label for="node-input-broker"><i class="fa fa-globe"></i> <span data-i18n="[placeholder]Broker">Broker</span></label>
        <input type="text" id="node-input-broker">
    </div>
    <div class="form-row">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.topic"></span></label>
        <input type="text" id="node-input-topic" data-i18n="[placeholder]mqtt-sparkplug-wrapper.label.topic">
    </div>
    <div class="form-row">
        <label for="node-input-qos"><i class="fa fa-empire"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.qos"></span></label>
        <select id="node-input-qos" style="width:125px !important">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
        </select>
    </div>
    <div class="form-tips"><span data-i18n="mqtt-sparkplug-wrapper.tip.sparkplugformat"></span></div>
</script>

<script type="text/javascript">
     RED.nodes.registerType('sparkplug in',{
        category: 'network',
        defaults: {
            name: {value:""},
            topic: {value:"spBv1.0/+/DDATA/+/+",required:true,validate: RED.validators.regex(/^(#$|(\+|[^+#]*)(\/(\+|[^+#]*))*(\/(\+|#|[^+#]*))?$)/)},
            qos: {value: "2"},
            broker: {type:"mqtt-sparkplug-broker", required:true},

        },
        color:"#2181a6",
        inputs:0,
        outputs:1,
        icon: "sparkplugio.svg",
        label: function() {
            return this.name ? this.name : this.topic || "sparkplug out";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {

            if (this.qos === undefined) {
                $("#node-input-qos").val("2");
            }

            let topicParts = this.topic.split("/");

        }
    });
</script>

<!-- sparkplug out-->
<script type="text/html" data-template-name="sparkplug out">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]mqtt-sparkplug-wrapper.label.name">
    </div>
    <div class="form-row">
        <label for="node-input-broker"><i class="fa fa-globe"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.broker"></span></label>
        <input type="text" id="node-input-broker">
    </div>
    <div class="form-row">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.topic"></span></label>
        <input type="text" id="node-input-topic" data-i18n="[placeholder]mqtt-sparkplug-wrapper.label.topic">
    </div>
    <div class="form-row mqtt-form-row-cols2">
        <label for="node-input-qos" class="mqtt-form-row-col1"><i class="fa fa-empire"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.qos"></span></label>
        <select id="node-input-qos" class="mqtt-form-row-col1">
            <option value=""></option>
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
        </select>
        <label for="node-input-retain" class="mqtt-form-row-col2"><i class="fa fa-history"></i> <span data-i18n="mqtt-sparkplug-wrapper.retain"></span></label>
        <select id="node-input-retain" class="mqtt-form-row-col2" >
            <option value=""></option>
            <option value="false" data-i18n="mqtt-sparkplug-wrapper.false"></option>
            <option value="true" data-i18n="mqtt-sparkplug-wrapper.true"></option>
        </select>
    </div>
    <div class="form-tips"><span data-i18n="mqtt-sparkplug-wrapper.tip.sparkplugformat"></span></div>
</script>

<script type="text/javascript">
RED.nodes.registerType('sparkplug out',{
    category: 'network',
    defaults: {
        name: {value:""},
        topic: {value:"spBv1.0/My Devices/NCMD/EoN Name/My Device",required:false,validate: RED.validators.regex(/^(#$|(\+|[^+#]*)(\/(\+|[^+#]*))*(\/(\+|#|[^+#]*))?$)/)},
        qos: {value:""},
        retain: {value:""},
        broker: {type:"mqtt-sparkplug-broker", required:true}
    },
    color:"#2181a6",
    inputs:1,
    outputs:0,
    icon: "sparkplugio.svg",
    align: "right",
    label: function() {
        return this.name||this.topic||"mqtt";
    },
    oneditprepare: function() {
        var that = this;
    },
    oneditsave: function() {

    },
    labelStyle: function() {
        return this.name?"node_label_italic":"";
    }
});
</script>



<!-- Sparkplug device listener -->
<script type="text/html" data-template-name="sparkplug device listener">

    <div class="form-row">
        <label for="node-input-name"><span data-i18n="mqtt-sparkplug-wrapper.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]mqtt-sparkplug-wrapper.placeholder.name">
    </div>
    <div class="form-row">
        <label for="node-input-broker"><i class="fa fa-globe"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.broker"></span></label>
        <input type="text" id="node-input-broker">
    </div>

    <div class="form-row">
        <ul style="min-width: 600px; margin-bottom: 20px;" id="node-mqtt-device-tabs"></ul>
    </div>

    <div id="node-mqtt-device-tabs-content" style="min-height:150px;">

        <div id="mqtt-device-tab-metrics-data" style="display:none">
            <label for="node-input-parseBirthData" style="width:70%">
                <input type="checkbox" id="node-input-parseBirthData" style="display:inline-block; width:22px; vertical-align:top;"><span data-i18n="mqtt-sparkplug-wrapper.label.parseBirthData"></span>
            </label>
            <label for="node-input-parseCommandData" style="width:70%">
                <input type="checkbox" id="node-input-parseCommandData" style="display:inline-block; width:22px; vertical-align:top;"><span data-i18n="mqtt-sparkplug-wrapper.label.parseCommandData"></span>
            </label>
            <div class="form-row sparkplug-input-metric-row" id="sparkplug-input-metric-container-row">
                <ol id="sparkplug-input-metric-data-container"></ol>
            </div>
        </div>

        <div id="mqtt-device-tab-metrics-cmd" style="display:none">
            <div class="form-row sparkplug-input-metric-row" id="sparkplug-input-metric-container-row">
                <ol id="sparkplug-input-metric-cmd-container"></ol>
            </div>
            <div class="form-tips"><span data-i18n="mqtt-sparkplug-wrapper.tip.device"></span></div>
        </div>

        <div id="mqtt-device-tab-advanced" style="display:none">

            <div class="form-row">
                <label for="node-input-broker"><span data-i18n="mqtt-sparkplug-wrapper.label.nodetype"></span></label>
                <span class="button-group">
                    <button type="button" data-value="eond" class="red-ui-button toggle device-type-button-group selected">Device (EoND)</button>
                    <button type="button" data-value="eon" class="red-ui-button toggle device-type-button-group">Node (EoN)</button>
                </span>
            </div>
            <div class="form-row">
                <label for="node-input-spEond"><i class="fa fa-tasks"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.eond"></span></label>
                <input type="text" id="node-input-spEond" data-i18n="[placeholder]mqtt-sparkplug-wrapper.placeholder.eondname">
            </div>
            <div class="form-row">
                <label for="node-input-spEon"><i class="fa fa-tasks"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.eon"></span></label>
                <input type="text" id="node-input-spEon" data-i18n="[placeholder]mqtt-sparkplug-wrapper.placeholder.eonname">
            </div>
            <div class="form-row">
                <label for="node-input-spGroup"><i class="fa fa-tasks"></i> <span data-i18n="mqtt-sparkplug-wrapper.label.group"></span></label>
                <input type="text" id="node-input-spGroup" data-i18n="[placeholder]mqtt-sparkplug-wrapper.placeholder.groupname">
            </div>
            <!-- UI for birthImmediately-->
            <div class="form-row">
                <label for="node-input-birthImmediately" style="width:70%">
                    <input type="checkbox" id="node-input-birthImmediately" style="display:inline-block; width:22px; vertical-align:top;"><span data-i18n="mqtt-sparkplug-wrapper.label.birthImmediately"></span>
                </label>
            </div>
            <div class="form-tips"><span data-i18n="mqtt-sparkplug-wrapper.tip.birthImmediately"></span></div>

        </div>

    </div>
</script>

<script type="text/javascript">
    (function() {

        /**
         * Function that returns a list of configured Data Metrics
         * @return   {Object} A object with all configured metrics.
         */
        function getMetricsListData() {
            var _metrics = {};
            var metrics = $("#sparkplug-input-metric-data-container").editableList("items");
            metrics.each(function(i) {
                var item = $(this);
                var name = item.find(".sparkplug-input-metric-name").val();
                var dt = item.find(".sparkplug-input-metric-dateType option:selected").text();

                if (name) {
                    _metrics[name] = { dataType : dt};
                }
            });
            return _metrics;
        }

        /**
         * Function that returns a list of configured Comand Metrics
         * @return   {Object} A object with all configured metrics.
         */
        function getMetricsListCmd() {
            var _metrics = {};
            var metrics = $("#sparkplug-input-metric-cmd-container").editableList("items");
            metrics.each(function(i) {
                var item = $(this);
                var name = item.find(".sparkplug-input-metric-name").val();
                var dt = item.find(".sparkplug-input-metric-dateType option:selected").text();

                if (name) {
                    _metrics[name] = { dataType : dt};
                }
            });
            return _metrics;
        }

        RED.nodes.registerType('sparkplug device listener',{
            category: 'network',
            defaults: {
                name: {value:""},
                spEond: {value:"",  validate :x => /^[^/+#]*$/.test(x)},
                spEon: {value:"",  validate :x => /^[^/+#]*$/.test(x)},
                spGroup: {value:"",  validate :x => /^[^/+#]*$/.test(x)},
                isEond: {value:true},
                metricsData: {value:{}, required:true, /*validate : x => Object.keys(x).length > 0*/ }, // do regex matching of invalid charaters (e.g. # or +)
                metricsCmd: {value:{}, required:true, /*validate : x => Object.keys(x).length > 0*/ }, // do regex matching of invalid charaters (e.g. # or +)
                broker: {type:"mqtt-sparkplug-broker", required:true},
                birthImmediately: {value: false},
                parseBirthData: {value: false},
                parseCommandData: {value: false},
                outputs: {value:1}, // To dynamically increase the number of outputs
            },
            color:"#2181a6",
            inputs: 1,
            inputLabels: "Input CMDs",
            outputs: 1,
            outputLabels: function(index){
                var dataName = Object.keys(this.metricsData)[index];
                if(dataName){
                    return "Data metric - " + dataName;
                }
            },
            icon: "sparkpluginout.svg",
            align: "right",
            label: function() {
                return this.name||"Sparkplug Device Listener";
            },
            oneditprepare: function() {
                var that = this;

                var tabs = RED.tabs.create({
                    id: "node-mqtt-device-tabs",
                    onchange: function(tab) {
                        $("#node-mqtt-device-tabs-content").children().hide();
                        $("#" + tab.id).show();
                    }
                });

                tabs.addTab({
                    id: "mqtt-device-tab-metrics-data",
                    label: this._("mqtt-sparkplug-wrapper.tabs-label.metrics-data"),
                    iconClass: "fa fa-cubes",
                });
                tabs.addTab({
                    id: "mqtt-device-tab-metrics-cmd",
                    label: this._("mqtt-sparkplug-wrapper.tabs-label.metrics-cmd"),
                    iconClass: "fa fa-cubes",
                });
                tabs.addTab({
                    id: "mqtt-device-tab-advanced",
                    label: this._("mqtt-sparkplug-wrapper.tabs-label.sparkplugNode"),
                    iconClass: "fa fa-cog"
                });

                // Command Metric list - Setup model
                var metricsCmdList = $("#sparkplug-input-metric-cmd-container").editableList( {
                    header: $("<div>").append($.parseHTML("<div style='width:80%; display: inline-grid'>Name</div><div style='display: inline-grid'>Type</div>")),
                    addButton: "add",
                    removable: true,
                    height: 300,
                    addItem: function(container,i,opt) {
                        var parent = container.parent();
                        var row = $("<div/>").addClass("sparkplug-input-metric").appendTo(container);
                        var fmoduleSpan = $("<span>").appendTo(row);
                        var fmodule = $("<input/>", {
                            class: "sparkplug-input-metric-name",
                            placeholder: "Metric Name",
                            type: "text"
                        }).css({
                        }).appendTo(fmoduleSpan).val(opt.name);

                        var selectField = $('<select/>',{
                            style:"width:110px; margin-left: 5px; text-align: center;",
                            class : "sparkplug-input-metric-dateType"
                        }).appendTo(row);
                        var group0 = $('<optgroup/>', { label: "Datatypes" }).appendTo(selectField);

                        var dt = ["Int8", "Int16", "Int32", "Int64", "Float", "Double", "Boolean" , "String", "Unknown"];
                        dt.forEach(d => {
                            let option = $("<option></option>").val(d).text(d);
                            group0.append(option);
                            if (d === opt.dataType || (Object.keys(opt).length === 0 && d === "Int32")) {
                                option.attr('selected','selected')
                            }
                        });
                    }
                });
                var metricsCmd = this.metricsCmd || {};
                for (const [key, value] of Object.entries(metricsCmd)) {
                    value["name"] = key;
                    metricsCmdList.editableList('addItem', value)
                };

                // Data Metric list - Setup model
                var metricsListData = $("#sparkplug-input-metric-data-container").editableList( {
                    header: $("<div>").append($.parseHTML("<div style='width:80%; display: inline-grid'>Name</div><div style='display: inline-grid'>Type</div>")),
                    addButton: "add",
                    removable: true,
                    height: 300,
                    addItem: function(container,i,opt) {
                        var parent = container.parent();
                        var row = $("<div/>").addClass("sparkplug-input-metric").appendTo(container);
                        var fmoduleSpan = $("<span>").appendTo(row);
                        var fmodule = $("<input/>", {
                            class: "sparkplug-input-metric-name",
                            placeholder: "Metric Name",
                            type: "text"
                        }).css({
                        }).appendTo(fmoduleSpan).val(opt.name);

                        var selectField = $('<select/>',{
                            style:"width:110px; margin-left: 5px; text-align: center;",
                            class : "sparkplug-input-metric-dateType"
                        }).appendTo(row);
                        var group0 = $('<optgroup/>', { label: "Datatypes" }).appendTo(selectField);

                        var dt = ["Int8", "Int16", "Int32", "Int64", "Float", "Double", "Boolean" , "String", "Unknown"];
                        dt.forEach(d => {
                            let option = $("<option></option>").val(d).text(d);
                            group0.append(option);
                            if (d === opt.dataType || (Object.keys(opt).length === 0 && d === "Int32")) {
                                option.attr('selected','selected')
                            }
                        });
                    }
                });
                var metricsData = this.metricsData || {};
                for (const [key, value] of Object.entries(metricsData)) {
                    value["name"] = key;
                    metricsListData.editableList('addItem', value)
                };

                // Selection of Eond / Eon
                function updateTextBoxEond() {
                    if (that.isEond) {
                        $("#node-input-spEond").prop('disabled', false);
                    } else {
                        $("#node-input-spEond").prop('disabled', true);
                    }
                }
                function updateselectButtonNodeType() {

                    updateTextBoxEond(); // Update text box state based on selected option

                    var savedOption = (that.isEond) ? "eond" : "eon";
                    $(".device-type-button-group").each(function() {
                        if ($(this).attr('data-value') === savedOption) {
                            $(this).addClass("active");
                        } else {
                            $(this).removeClass("active");
                        }
                    });
                }
                $(".device-type-button-group").on("click", function() {
                    $(".device-type-button-group").removeClass("selected");
                    $(this).addClass("selected")
                    that.isEond = $(this).attr("data-value") == "eond";
                    updateTextBoxEond();
                });
                updateselectButtonNodeType();
            },
            oneditsave: function() {
                var node = this;
                node.metricsData = getMetricsListData();
                node.metricsCmd = getMetricsListCmd();
                node.outputs = Object.keys(this.metricsData).length;
                this.warn("Saving...");
                this.warn($(this).attr('data-value'));
            },

            labelStyle: function() {
                return this.name?"node_label_italic":"";
            }
        });
    })();
</script>